<!DOCTYPE html>
<html lang="pl">
<head>
  <meta charset="UTF-8" />
  <link rel="icon" type="image/svg+xml" href="/vite.svg" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />
  <title>Generator CV - Covebo</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;500;600;700&display=swap" rel="stylesheet">
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
  <style>
    body { font-family: 'Poppins', sans-serif; touch-action: pan-x pan-y; }
    ::-webkit-scrollbar { width: 8px; }
    ::-webkit-scrollbar-track { background: #f1f1f1; }
    ::-webkit-scrollbar-thumb { background: #888; border-radius: 4px; }
    ::-webkit-scrollbar-thumb:hover { background: #555; }
     /* Ukrycie podglądu CV na telefonach, gdy aktywny jest formularz */
    @media (max-width: 768px) {
        .mobile-view-form #cv-preview-container {
            display: none;
        }
        .mobile-view-preview #cv-form-container {
            display: none;
        }
    }
  </style>
<script type="importmap">
{
  "imports": {
    "react": "https://esm.sh/react@18.2.0",
    "react-dom/client": "https://esm.sh/react-dom@18.2.0/client",
    "react-dom/": "https://aistudiocdn.com/react-dom@^19.2.0/",
    "react/": "https://aistudiocdn.com/react@^19.2.0/"
  }
}
</script>
</head>
<body class="bg-gray-100 overscroll-none">
  <div id="root"></div>
  <script type="module">
    import React, { useState, useEffect, useRef } from 'react';
    import ReactDOM from 'react-dom/client';

    // --- UTILS ---
    const generateUniqueId = () => new Date().getTime().toString() + Math.random().toString(36).substring(2, 9);

    // Function to crop and round the image on a canvas
    const getRoundedCanvasCroppedImage = async (imageUrl, position, targetSize = 180) => {
        if (!imageUrl) return '';

        return new Promise((resolve) => {
            const img = new Image();
            img.onload = () => {
                const canvas = document.createElement('canvas');
                canvas.width = targetSize;
                canvas.height = targetSize;
                const ctx = canvas.getContext('2d');

                // Calculate image dimensions to fit/cover
                const imgAspectRatio = img.width / img.height;
                const targetAspectRatio = 1; // Square crop

                let sx = 0, sy = 0, sWidth = img.width, sHeight = img.height;
                let dx = 0, dy = 0, dWidth = targetSize, dHeight = targetSize;

                if (imgAspectRatio > targetAspectRatio) { // Image is wider than the target square
                    sHeight = img.height;
                    sWidth = img.height * targetAspectRatio;
                    sx = (img.width - sWidth) * (position.x / 100);
                } else { // Image is taller or same aspect ratio as the target square
                    sWidth = img.width;
                    sHeight = img.width / targetAspectRatio;
                    sy = (img.height - sHeight) * (position.y / 100);
                }
                
                // Ensure source dimensions are positive
                if (sWidth <= 0 || sHeight <= 0) {
                    resolve('');
                    return;
                }

                ctx.save();
                ctx.beginPath();
                ctx.arc(targetSize / 2, targetSize / 2, targetSize / 2, 0, Math.PI * 2, true);
                ctx.closePath();
                ctx.clip();

                // Draw the image onto the canvas, fitting it correctly
                ctx.drawImage(img, sx, sy, sWidth, sHeight, dx, dy, dWidth, dHeight);

                ctx.restore();

                resolve(canvas.toDataURL('image/png'));
            };
            img.onerror = () => resolve(''); // Handle image loading errors
            img.src = imageUrl;
        });
    };

    // --- SERVICES/PDFGENERATOR.TS ---
    const createPdf = async (elementId, outputType = 'save') => {
      const originalElement = document.getElementById(elementId);
      if (!originalElement) {
        throw new Error(`Element with id "${elementId}" not found.`);
      }

      const clone = originalElement.cloneNode(true);
      
      // FIX 1: Usunięcie cienia i ustawienie stylów dla klona
      clone.classList.remove('shadow-2xl'); 
      clone.style.position = 'absolute';
      clone.style.top = '0';
      clone.style.left = '-9999px';
      clone.style.width = '210mm';
      clone.style.height = 'auto';
      clone.style.transform = 'none';
      clone.style.margin = '0';
      // Reset zoom for PDF generation
      clone.style.zoom = '1'; 
      clone.style.transform = 'none';
      
      document.body.appendChild(clone);

      try {
        const scale = 3;
        
        // FIX 2: Dodano .cv-logo-wrapper do listy elementów, których nie wolno przecinać
        const unbreakableElements = Array.from(clone.querySelectorAll('.mb-6, .list-disc > li, .cv-logo-wrapper'));
        
        const elementPositions = unbreakableElements.map(el => ({
            top: el.offsetTop * scale,
            bottom: (el.offsetTop + el.offsetHeight) * scale
        }));

        const canvas = await window.html2canvas(clone, {
          scale,
          useCORS: true,
          logging: false,
          height: clone.scrollHeight,
          windowHeight: clone.scrollHeight,
          scrollY: -window.scrollY
        });

        const { jsPDF } = window.jspdf;
        const pdf = new jsPDF({ orientation: 'portrait', unit: 'mm', format: 'a4' });

        const a4Width = 210;
        const a4Height = 297;
        const topMargin = 15;
        const bottomMargin = 15;

        const sourceCanvas = canvas;
        const sourceWidthPx = sourceCanvas.width;
        const sourceHeightPx = sourceCanvas.height;
        const pxPerMm = sourceWidthPx / a4Width;
        
        let startY_px = 0;
        
        while (startY_px < sourceHeightPx) {
          if (startY_px > 0) pdf.addPage();
          
          const isFirstPage = startY_px === 0;
          const currentTopMargin = isFirstPage ? 0 : topMargin;
          const contentHeightOnPageMm = a4Height - currentTopMargin - bottomMargin;
          const contentOnPagePx = contentHeightOnPageMm * pxPerMm;

          const proposedCutPx = startY_px + contentOnPagePx;
          let actualCutPx = proposedCutPx;

          if (proposedCutPx < sourceHeightPx) {
            let lastElementBeforeCut = null;
            for (const el of elementPositions) {
                if (el.top < proposedCutPx) {
                    lastElementBeforeCut = el;
                } else {
                    break;
                }
            }
            
            if (lastElementBeforeCut && lastElementBeforeCut.bottom > proposedCutPx && lastElementBeforeCut.top > startY_px) {
              actualCutPx = lastElementBeforeCut.top;
            }
          } else {
            actualCutPx = sourceHeightPx;
          }

          const heightToCopy_px = actualCutPx - startY_px;

          const pageCanvas = document.createElement('canvas');
          pageCanvas.width = sourceWidthPx;
          pageCanvas.height = heightToCopy_px;
          const pageCtx = pageCanvas.getContext('2d');

          pageCtx.fillStyle = '#ffffff';
          pageCtx.fillRect(0, 0, sourceWidthPx, heightToCopy_px);

          pageCtx.drawImage(
            sourceCanvas,
            0, startY_px, sourceWidthPx, heightToCopy_px,
            0, 0, sourceWidthPx, heightToCopy_px
          );

          const pageImgData = pageCanvas.toDataURL('image/png');
          const pageImgHeightMm = heightToCopy_px / pxPerMm;
          
          pdf.addImage(pageImgData, 'PNG', 0, currentTopMargin, a4Width, pageImgHeightMm);
          
          startY_px = actualCutPx;
        }

        if (outputType === 'save') {
          pdf.save('cv.pdf');
          return null;
        } else {
          const blob = pdf.output('blob');
          return new File([blob], 'cv.pdf', { type: 'application/pdf' });
        }
      } catch (error) {
        console.error("PDF generation failed", error);
        throw error;
      } finally {
        document.body.removeChild(clone);
      }
    };
    
    const generatePdf = (elementId) => createPdf(elementId, 'save');
    const generatePdfBlob = (elementId, filename = 'cv.pdf') => createPdf(elementId, 'blob').then(file => {
        return new File([file], filename, { type: 'application/pdf' });
    });


    // --- COMPONENTS/ICONS.TSX ---
    const ConveyorIcon = (props) => React.createElement('svg', { xmlns: "http://www.w3.org/2000/svg", width: "24", height: "24", viewBox: "0 0 24 24", fill: "none", stroke: "currentColor", strokeWidth: "1.5", strokeLinecap: "round", strokeLinejoin: "round", ...props },
        React.createElement('path', { d: "M10.25 2.75a2.5 2.5 0 0 0-4.5 0" }),
        React.createElement('path', { d: "M7.5 2.75v12.5" }),
        React.createElement('path', { d: "m18 15.25-2.5-2.5" }),
        React.createElement('path', { d: "m15.5 15.25 2.5-2.5" }),
        React.createElement('path', { d: "m13 15.25-2.5-2.5" }),
        React.createElement('path', { d: "m10.5 15.25 2.5-2.5" }),
        React.createElement('path', { d: "M12.25 21.25h-9a1 1 0 0 1-1-1v-4.5a1 1 0 0 1 1-1h13.5a1 1 0 0 1 1 1v4.5a1 1 0 0 1-1 1h-2.25" }),
        React.createElement('circle', { cx: "18", cy: "18", r: "3.25" })
    );

    const ScannerIcon = (props) => React.createElement('svg', { xmlns: "http://www.w3.org/2000/svg", width: "24", height: "24", viewBox: "0 0 24 24", fill: "none", stroke: "currentColor", strokeWidth: "1.5", strokeLinecap: "round", strokeLinejoin: "round", ...props },
        React.createElement('path', { d: "M5.5 4.75a1 1 0 0 1 1-1h11a1 1 0 0 1 1 1v14.5a1 1 0 0 1-1-1h-11a1 1 0 0 1-1-1Z" }),
        React.createElement('path', { d: "M8.5 8.75h7" }),
        React.createElement('path', { d: "M8.5 12.75h4" }),
        React.createElement('path', { d: "M21.25 10.75a4.5 4.5 0 0 0 0 3" })
    );

    const ChevronIcon = ({ className }) => React.createElement('svg', { xmlns: "http://www.w3.org/2000/svg", width: "24", height: "24", viewBox: "0 0 24 24", fill: "none", stroke: "currentColor", strokeWidth: "2", strokeLinecap: "round", strokeLinejoin: "round", className }, React.createElement('polyline', { points: "6 9 12 15 18 9" }));

    // --- NEW ICONS FOR TOOLBAR ---
    const DownloadIcon = (props) => React.createElement('svg', { xmlns: "http://www.w3.org/2000/svg", width: "24", height: "24", viewBox: "0 0 24 24", fill: "none", stroke: "currentColor", strokeWidth: "2", strokeLinecap: "round", strokeLinejoin: "round", ...props }, React.createElement('path', { d: "M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4" }), React.createElement('polyline', { points: "7 10 12 15 17 10" }), React.createElement('line', { x1: "12", y1: "15", x2: "12", y2: "3" }));
    
    const MailIcon = (props) => React.createElement('svg', { xmlns: "http://www.w3.org/2000/svg", width: "24", height: "24", viewBox: "0 0 24 24", fill: "none", stroke: "currentColor", strokeWidth: "2", strokeLinecap: "round", strokeLinejoin: "round", ...props }, React.createElement('rect', { width: "20", height: "16", x: "2", y: "4", rx: "2" }), React.createElement('path', { d: "m22 7-8.97 5.7a1.94 1.94 0 0 1-2.06 0L2 7" }));
    
    const MessageIcon = (props) => React.createElement('svg', { xmlns: "http://www.w3.org/2000/svg", width: "24", height: "24", viewBox: "0 0 24 24", fill: "none", stroke: "currentColor", strokeWidth: "2", strokeLinecap: "round", strokeLinejoin: "round", ...props }, React.createElement('path', { d: "M21 11.5a8.38 8.38 0 0 1-.9 3.8 8.5 8.5 0 0 1-7.6 4.7 8.38 8.38 0 0 1-3.8-.9L3 21l1.9-5.7a8.38 8.38 0 0 1-.9-3.8 8.5 8.5 0 0 1 4.7-7.6 8.38 8.38 0 0 1 3.8-.9h.5a8.48 8.48 0 0 1 8 8v.5z" }));


    // --- COMPONENTS/CVPREVIEW.TSX ---
    const SectionTitle = ({ children }) => React.createElement('h2', { className: "text-[#E31D2A] text-lg tracking-[0.3em] font-semibold mb-6 uppercase" }, children);

    const CvPreview = ({ cvData, id, className }) => {
      // Use croppedProfilePictureUrl if available, otherwise fallback to original
      const { name, profilePictureUrl, croppedProfilePictureUrl, dob, personalDetails, skills, languages, workExperience, education } = cvData;
      const baseClasses = "bg-white text-black min-h-[297mm] shadow-2xl flex flex-col";
      
      const headerHeight = 140;
      const profileImageSize = 180;
      const profileImageTop = headerHeight - (profileImageSize / 2);
      const mainPaddingTop = (profileImageSize / 2) + 24;

      return React.createElement('div', { id: id, className: `${baseClasses} ${className}`, style: { fontFamily: "'Poppins', sans-serif" } },
        // MODIFIED HEADER
        React.createElement('header', { 
          className: "relative text-white", // Removed bg color
          style: { height: `${headerHeight}px` }
        },
          // Background Image
          React.createElement('img', {
              src: "Covebostopka.png",
              alt: "Nagłówek",
              className: "absolute inset-0 w-full h-full object-cover z-0"
          }),

          // Content Container
          // Enforced desktop padding (px-10)
          React.createElement('div', { className: "relative z-10 flex items-center w-full h-full px-10" },
            // We push the name to the right side.
            // Profile picture is absolute left-10 (~40px) + width 180px.
            // Text needs to be clear of that area.
            React.createElement('div', { className: 'w-full flex justify-end items-center' },
              React.createElement('h1', { className: "text-4xl font-bold leading-tight tracking-wide break-words uppercase drop-shadow-md text-right" }, name || 'Imię i Nazwisko')
            )
          ),
          
          // Profile Picture Container
          React.createElement('div', { 
            className: "absolute left-10 rounded-full bg-white p-2 shadow-lg z-20", // Added z-20 to be on top of bg image
            style: { top: `${profileImageTop}px`, width: `${profileImageSize}px`, height: `${profileImageSize}px` }
          },
            React.createElement('img', { 
                // Now uses croppedProfilePictureUrl directly
                src: croppedProfilePictureUrl || `https://picsum.photos/seed/${name || 'placeholder'}/180`, 
                alt: name, 
                className: "w-full h-full rounded-full object-cover",
                style: { objectPosition: `50% 50%` } // object-position no longer needed here as image is pre-cropped
            })
          )
        ),
        // MODIFIED: Enforced desktop layout (flex-row) instead of flex-col on mobile
        React.createElement('main', { 
          className: "flex flex-row flex-grow",
          style: { paddingTop: `${mainPaddingTop}px` }
        },
          // MODIFIED: Enforced desktop widths and order
          React.createElement('div', { className: "w-[38%] p-6 pl-10 pr-6 pb-8 order-1" },
            React.createElement('div', { className: "bg-gray-100 p-6 h-full" },
                React.createElement('div', null,
                  dob && React.createElement('div', { className: "mb-6" },
                    React.createElement('h3', { className: "text-[#E31D2A] text-xs font-bold tracking-[0.15em] uppercase mb-1" }, "Data urodzenia"),
                    React.createElement('p', { className: "text-sm text-black font-normal break-words" }, dob)
                  ),
                  personalDetails && personalDetails.length > 0 && React.createElement('div', { className: "mb-6" },
                    React.createElement('h3', { className: "text-[#E31D2A] text-xs font-bold tracking-[0.15em] uppercase mb-1" }, "Uprawnienia"),
                    React.createElement('ul', { className: "list-disc pl-5 space-y-1" },
                      personalDetails.map(detail => React.createElement('li', { key: detail.id, className: "text-sm text-black font-normal break-words" }, detail.text))
                    )
                  ),
                  skills && skills.length > 0 && React.createElement('div', { className: "mb-6" },
                    React.createElement('h3', { className: "text-[#E31D2A] text-xs font-bold tracking-[0.15em] uppercase mb-1" }, "Dodatkowe umiejętności"),
                    React.createElement('ul', { className: "list-disc pl-5 space-y-1" },
                      skills.map(skill => React.createElement('li', { key: skill.id, className: "text-sm text-black font-normal break-words" }, skill.text))
                    )
                  ),
                  languages && languages.length > 0 && React.createElement('div', null,
                    React.createElement('h3', { className: "text-[#E31D2A] text-xs font-bold tracking-[0.15em] uppercase mb-1" }, "Znajomość języków obcych"),
                    React.createElement('ul', { className: "list-disc pl-5 space-y-1" },
                      languages.map(language => React.createElement('li', { key: language.id, className: "text-sm text-black font-normal break-words" }, language.text))
                    )
                  )
                )
            )
          ),
          // MODIFIED: Enforced desktop widths and order
          React.createElement('div', { className: "w-[62%] p-6 pr-10 order-2 flex flex-col" },
            React.createElement('div', null,
                workExperience && workExperience.length > 0 && React.createElement(React.Fragment, null,
                React.createElement(SectionTitle, null, "Doświadczenie"),
                workExperience.map((exp) => React.createElement('div', { key: exp.id, className: "mb-6" },
                  React.createElement('p', { className: "font-bold text-sm tracking-wide break-words uppercase" }, `${exp.jobTitle}, ${exp.company}`),
                  React.createElement('p', { className: "text-xs text-black my-2" }, exp.dateRange),
                  React.createElement('ul', { className: "list-disc pl-5 text-xs space-y-1" },
                  exp.tasks.map(task => React.createElement('li', { key: task.id, className: "break-words" }, task.text))
                  )
                ))
                ),
                education && education.length > 0 && React.createElement('div', { className: "mt-8" },
                React.createElement(SectionTitle, null, "Edukacja"),
                education.map((edu) => React.createElement('div', { key: edu.id, className: "mb-6" },
                  React.createElement('p', { className: "font-bold text-sm tracking-wide break-words uppercase" }, `${edu.degree}, ${edu.schoolName}`),
                  React.createElement('p', { className: "text-xs text-black my-2" }, edu.dateRange),
                  edu.description && React.createElement('p', { className: "text-xs mt-1 break-words" }, edu.description)
                ))
                )
            ),
            React.createElement('div', { className: 'flex-grow min-h-[24px]' }),
            // FIX 4: Klasa cv-logo-wrapper dla łatwego identyfikowania
            React.createElement('div', { className: 'pt-6 flex justify-end cv-logo-wrapper' },
              React.createElement('img', {
                  src: "logo-covebo-icon.png",
                  alt: "Covebo Logo",
                  className: "w-24 h-auto block"
              })
            )
          )
        )
      );
    };

    // --- COMPONENTS/CVFORM.TSX ---
    const Input = ({ label, value, onChange, placeholder = "" }) => React.createElement('div', { className: "mb-3" },
      React.createElement('label', { className: "block text-sm font-medium text-gray-600 mb-1" }, label),
      React.createElement('input', { type: "text", value: value, onChange: onChange, placeholder: placeholder, className: "w-full border border-gray-300 rounded-md p-2 text-sm focus:ring-red-500 focus:border-red-500" })
    );

    // MODIFIED SECTION COMPONENT: ACCORDION STYLE
    const Section = ({ title, children, description, defaultOpen = false }) => {
      const [isOpen, setIsOpen] = useState(defaultOpen);

      return React.createElement('div', { className: "mb-4 border border-gray-200 rounded-lg bg-white overflow-hidden shadow-sm" },
        React.createElement('button', { 
          type: "button",
          onClick: () => setIsOpen(!isOpen),
          className: "w-full flex justify-between items-center p-4 bg-gray-50 hover:bg-gray-100 transition-colors text-left"
        },
          React.createElement('div', null,
            React.createElement('h3', { className: "text-lg font-bold text-gray-800" }, title),
            // Show description only if closed and description is provided
            !isOpen && description && React.createElement('p', { className: "text-xs text-gray-500 mt-1 font-normal" }, description)
          ),
          React.createElement(ChevronIcon, { className: `w-5 h-5 text-gray-500 transform transition-transform duration-200 ${isOpen ? 'rotate-180' : ''}` })
        ),
        isOpen && React.createElement('div', { className: "p-4 border-t border-gray-200 bg-gray-50/30" }, 
          children
        )
      );
    };

    // --- NEW COMPONENT: ImageCropper ---
    const ImageCropper = ({ imageUrl, position, onPositionChange }) => {
      const [isDragging, setIsDragging] = useState(false);
      const [startPos, setStartPos] = useState({ x: 0, y: 0 });
      const [startImgPos, setStartImgPos] = useState({ x: 0, y: 0 });
      const containerRef = useRef(null);

      const handleMouseDown = (e) => {
        e.preventDefault();
        setIsDragging(true);
        setStartPos({ x: e.clientX, y: e.clientY });
        setStartImgPos({ ...position });
      };

      const handleMouseMove = (e) => {
        if (!isDragging || !containerRef.current) return;
        const dx = e.clientX - startPos.x;
        const dy = e.clientY - startPos.y;
        
        // Adjust sensitivity based on the container size to make dragging intuitive
        const containerWidth = containerRef.current.offsetWidth;
        const containerHeight = containerRef.current.offsetHeight;
        
        // Calculate the maximum possible offset for the image to still cover the circle
        // This is a rough estimate and might need fine-tuning based on image aspect ratio
        // For simplicity, we assume image fills at least 100% of the circle dimension.
        // A smaller sensitivity means you drag less to move the image more.
        const sensitivityX = 100 / (containerWidth * 2); // Divide by 2 to make it less sensitive
        const sensitivityY = 100 / (containerHeight * 2);

        let newX = startImgPos.x - (dx * sensitivityX);
        let newY = startImgPos.y - (dy * sensitivityY);

        newX = Math.max(0, Math.min(100, newX));
        newY = Math.max(0, Math.min(100, newY));

        onPositionChange({ x: newX, y: newY });
      };

      const handleMouseUp = () => setIsDragging(false);

      useEffect(() => {
        if (isDragging) {
          window.addEventListener('mousemove', handleMouseMove);
          window.addEventListener('mouseup', handleMouseUp);
        } else {
          window.removeEventListener('mousemove', handleMouseMove);
          window.removeEventListener('mouseup', handleMouseUp);
        }
        return () => {
          window.removeEventListener('mousemove', handleMouseMove);
          window.removeEventListener('mouseup', handleMouseUp);
        };
      }, [isDragging, handleMouseMove]);

      return React.createElement('div', { className: "mt-4" },
        React.createElement('p', { className: "text-xs font-bold text-gray-700 mb-2" }, "Przesuń zdjęcie myszką, aby wykadrować:"),
        React.createElement('div', { 
            ref: containerRef,
            className: "w-32 h-32 rounded-full overflow-hidden border-2 border-red-500 cursor-grab active:cursor-grabbing relative mx-auto bg-gray-200 shadow-sm",
            onMouseDown: handleMouseDown,
            title: "Chwyć i przesuń"
        },
            React.createElement('img', {
                src: imageUrl,
                className: "w-full h-full object-cover pointer-events-none",
                style: { objectPosition: `${position.x}% ${position.y}%` }
            })
        ),
        React.createElement('p', { className: "text-[10px] text-gray-400 text-center mt-2" }, "Podgląd kadrowania")
      );
    };

    const CvForm = ({ cvData, setCvData }) => {
      const handleFieldChange = (field, value) => {
        setCvData(prev => ({ ...prev, [field]: value }));
      };

      const handleImageUpload = (event) => {
        const file = event.target.files?.[0];
        if (file) {
          const reader = new FileReader();
          reader.onloadend = () => {
            setCvData(prev => ({ ...prev, profilePictureUrl: reader.result, imagePosition: { x: 50, y: 50 } })); // Reset position on new upload
          };
          reader.readAsDataURL(file);
        }
      };

      const handleDynamicChange = (section, itemId, field, value) => {
        const items = cvData[section];
        const newItems = items.map((item) =>
          item.id === itemId ? { ...item, [field]: value } : item
        );
        setCvData(prev => ({ ...prev, [section]: newItems }));
      };

      const handleTaskChange = (workId, taskId, value) => {
        const newWorkExperience = cvData.workExperience.map((work) => {
          if (work.id === workId) {
            const newTasks = work.tasks.map(task =>
              task.id === taskId ? { ...task, text: value } : task
            );
            return { ...work, tasks: newTasks };
          }
          return work;
        });
        setCvData(prev => ({ ...prev, workExperience: newWorkExperience }));
      };

      const addTask = (workId) => {
        const newWorkExperience = cvData.workExperience.map((work) => {
          if (work.id === workId) {
            return { ...work, tasks: [...work.tasks, { id: generateUniqueId(), text: '' }] };
          }
          return work;
        });
        setCvData(prev => ({ ...prev, workExperience: newWorkExperience }));
      };

      const removeTask = (workId, taskId) => {
        const newWorkExperience = cvData.workExperience.map((work) => {
          if (work.id === workId) {
            return { ...work, tasks: work.tasks.filter(task => task.id !== taskId) };
          }
          return work;
        });
        setCvData(prev => ({ ...prev, workExperience: newWorkExperience }));
      };

      const addItem = (section) => {
        const id = generateUniqueId();
        let newItem;
        switch (section) {
          case 'personalDetails':
          case 'skills':
          case 'languages':
            newItem = { id, text: '' };
            break;
          case 'workExperience':
            newItem = { id, jobTitle: '', company: '', dateRange: '', tasks: [{ id: generateUniqueId(), text: '' }] };
            break;
          case 'education':
            newItem = { id, degree: '', schoolName: '', dateRange: '', description: '' };
            break;
          case 'education':
            newItem = { id, degree: '', schoolName: '', dateRange: '', description: '' };
            break;
          default:
            return;
        }
        setCvData(prev => ({ ...prev, [section]: [...prev[section], newItem] }));
      };

      const removeItem = (section, itemId) => {
        setCvData(prev => ({
          ...prev,
          [section]: prev[section].filter(item => item.id !== itemId)
        }));
      };

      const renderWorkExperience = () => cvData.workExperience.map((work) => React.createElement(Section, { key: work.id, title: work.jobTitle || "Nowe doświadczenie zawodowe", defaultOpen: true },
        React.createElement(Input, { label: "Stanowisko", value: work.jobTitle, onChange: (e) => handleDynamicChange('workExperience', work.id, 'jobTitle', e.target.value) }),
        React.createElement(Input, { label: "Firma", value: work.company, onChange: (e) => handleDynamicChange('workExperience', work.id, 'company', e.target.value) }),
        React.createElement(Input, { label: "Okres (np. 01.2020 - 12.2023)", value: work.dateRange, onChange: (e) => handleDynamicChange('workExperience', work.id, 'dateRange', e.target.value) }),
        React.createElement('div', { className: "mb-3" },
          React.createElement('label', { className: "block text-sm font-medium text-gray-600 mb-1" }, "Zakres obowiązków (lista)"),
          work.tasks.map((task) => React.createElement('div', { key: task.id, className: "flex items-center space-x-2 mb-2" },
            React.createElement('input', { type: "text", value: task.text, onChange: (e) => handleTaskChange(work.id, task.id, e.target.value), placeholder: "Obowiązek...", className: "flex-grow border border-gray-300 rounded-md p-2 text-sm" }),
            React.createElement('button', { type: "button", onClick: () => removeTask(work.id, task.id), className: "text-red-500 hover:text-red-700 text-lg p-1" }, "\u00D7")
          )),
          React.createElement('button', { type: "button", onClick: () => addTask(work.id), className: "mt-2 text-xs text-blue-600 hover:text-blue-800" }, " + Dodaj obowiązek")
        ),
        React.createElement('button', { type: "button", onClick: () => removeItem('workExperience', work.id), className: "mt-4 text-xs text-red-600 hover:text-red-800" }, "Usuń to doświadczenie")
      ));

      const renderEducation = () => cvData.education.map((edu) => React.createElement(Section, { key: edu.id, title: edu.degree || "Nowa szkoła/kurs", defaultOpen: true },
        React.createElement(Input, { label: "Stopień/Kwalifikacja", value: edu.degree, onChange: (e) => handleDynamicChange('education', edu.id, 'degree', e.target.value) }),
        React.createElement(Input, { label: "Nazwa instytucji", value: edu.schoolName, onChange: (e) => handleDynamicChange('education', edu.id, 'schoolName', e.target.value) }),
        React.createElement(Input, { label: "Okres (np. 09.2015 - 06.2019)", value: edu.dateRange, onChange: (e) => handleDynamicChange('education', edu.id, 'dateRange', e.target.value) }),
        React.createElement('div', { className: "mb-3" },
          React.createElement('label', { className: "block text-sm font-medium text-gray-600 mb-1" }, "Opis (opcjonalnie)"),
          React.createElement('textarea', { value: edu.description, onChange: (e) => handleDynamicChange('education', edu.id, 'description', e.target.value), placeholder: "Krótki opis kierunku/szkoły...", className: "w-full border border-gray-300 rounded-md p-2 text-sm focus:ring-red-500 focus:border-red-500" })
        ),
        React.createElement('button', { type: "button", onClick: () => removeItem('education', edu.id), className: "mt-4 text-xs text-red-600 hover:text-red-800" }, "Usuń tę edukację")
      ));

      const renderSimpleList = (section, title, placeholder) => React.createElement(Section, { title: title, defaultOpen: false, description: "Rozwiń, aby edytować listę" },
        cvData[section].map((item) => React.createElement('div', { key: item.id, className: "flex items-center space-x-2 mb-2" },
          React.createElement('input', { type: "text", value: item.text, onChange: (e) => handleDynamicChange(section, item.id, 'text', e.target.value), placeholder: placeholder, className: "flex-grow border border-gray-300 rounded-md p-2 text-sm" }),
          React.createElement('button', { type: "button", onClick: () => removeItem(section, item.id), className: "text-red-500 hover:text-red-700 text-lg p-1" }, "\u00D7")
        )),
        React.createElement('button', { type: "button", onClick: () => addItem(section), className: "mt-2 text-xs text-blue-600 hover:text-blue-800" }, `+ Dodaj ${title.toLowerCase().slice(0, -1)}`)
      );

      return React.createElement('div', { id: "cv-form-container", className: "p-6 bg-white shadow-xl h-full overflow-y-auto w-full md:w-1/2 lg:w-2/5" },
        React.createElement('h2', { className: "text-2xl font-bold text-red-700 mb-6" }, "Edytor CV"),
        React.createElement(Section, { title: "Dane Podstawowe", defaultOpen: true },
          React.createElement(Input, { label: "Imię i Nazwisko", value: cvData.name, onChange: (e) => handleFieldChange('name', e.target.value), placeholder: "Jan Kowalski" }),
          React.createElement(Input, { label: "Data urodzenia", value: cvData.dob, onChange: (e) => handleFieldChange('dob', e.target.value), placeholder: "01.01.1990" }),
          React.createElement('div', { className: "mb-3" },
            React.createElement('label', { className: "block text-sm font-medium text-gray-600 mb-1" }, "Zdjęcie Profilowe"),
            React.createElement('input', { type: "file", onChange: handleImageUpload, accept: "image/*", className: "w-full text-sm text-gray-500 file:mr-4 file:py-2 file:px-4 file:rounded-full file:border-0 file:text-sm file:font-semibold file:bg-red-50 file:text-red-700 hover:file:bg-red-100" })
          ),
          cvData.profilePictureUrl && React.createElement(ImageCropper, {
            imageUrl: cvData.profilePictureUrl,
            position: cvData.imagePosition,
            onPositionChange: (newPos) => handleFieldChange('imagePosition', newPos)
          })
        ),
        
        // CHANGED: Accordion for Work Experience with default closed and description
        React.createElement(Section, { title: "Doświadczenie Zawodowe", description: "Dodaj doświadczenie / edytuj doświadczenie", defaultOpen: false },
          renderWorkExperience(),
          React.createElement('button', { type: "button", onClick: () => addItem('workExperience'), className: "mt-4 w-full py-2 px-4 border border-red-500 text-red-600 rounded-md hover:bg-red-50 font-medium transition duration-150" }, " + Dodaj nowe doświadczenie")
        ),
        
        renderSimpleList('personalDetails', 'Uprawnienia (np. Prawo Jazdy, SEP)', 'Wózek widłowy...'),
        renderSimpleList('languages', 'Znajomość Języków Obcych', 'Angielski B1'),
        renderSimpleList('skills', 'Dodatkowe Umiejętności', 'Obsługa maszyn CNC'),

        React.createElement(Section, { title: "Edukacja", description: "Dodaj szkołę / edytuj edukację", defaultOpen: false },
          renderEducation(),
          React.createElement('button', { type: "button", onClick: () => addItem('education'), className: "mt-4 w-full py-2 px-4 border border-red-500 text-red-600 rounded-md hover:bg-red-50 font-medium transition duration-150" }, " + Dodaj nowy wpis edukacyjny")
        ),

        React.createElement('div', { className: "mt-8 sticky bottom-0 bg-white pt-4 pb-4 border-t" },
          React.createElement('button', { 
            type: "button", 
            onClick: () => generatePdf('cv-document'), 
            className: "w-full bg-red-600 text-white py-3 rounded-lg font-semibold shadow-md hover:bg-red-700 transition duration-200" 
          }, "Pobierz CV jako PDF")
        )
      );
    };
    
    // --- APP.TSX ---
    const defaultData = {
      name: 'Jan Kowalski',
      dob: '01.01.1990',
      profilePictureUrl: 'https://placehold.co/180x180/E31D2A/ffffff?text=ZDJĘCIE',
      croppedProfilePictureUrl: 'https://placehold.co/180x180/E31D2A/ffffff?text=ZDJĘCIE',
      imagePosition: { x: 50, y: 50 },
      personalDetails: [
        { id: generateUniqueId(), text: 'Prawo jazdy kat. B' },
        { id: generateUniqueId(), text: 'Uprawnienia na wózki widłowe' },
      ],
      skills: [
        { id: generateUniqueId(), text: 'Obsługa pakowarki automatycznej' },
        { id: generateUniqueId(), text: 'Podstawowa obsługa komputera (MS Office)' },
      ],
      languages: [
        { id: generateUniqueId(), text: 'Angielski - komunikatywny (B1)' },
      ],
      workExperience: [
        {
          id: generateUniqueId(),
          jobTitle: 'Pracownik Produkcji',
          company: 'Fabryka Mebli "Drzewko"',
          dateRange: '03.2020 - obecnie',
          tasks: [
            { id: generateUniqueId(), text: 'Obsługa maszyn stolarskich i narzędzi ręcznych' },
            { id: generateUniqueId(), text: 'Montaż komponentów meblowych zgodnie z instrukcją' },
            { id: generateUniqueId(), text: 'Kontrola jakości gotowych produktów' }
          ]
        },
        {
          id: generateUniqueId(),
          jobTitle: 'Magazynier',
          company: 'Centrum Logistyczne "Szybkie Paczki"',
          dateRange: '08.2018 - 02.2020',
          tasks: [
            { id: generateUniqueId(), text: 'Przyjmowanie i wydawanie towaru z magazynu' },
            { id: generateUniqueId(), text: 'Kompletacja zamówień i przygotowanie do wysyłki' },
            { id: generateUniqueId(), text: 'Obsługa skanera magazynowego' }
          ]
        }
      ],
      education: [
        {
          id: generateUniqueId(),
          degree: 'Technik Logistyk',
          schoolName: 'Zespół Szkół Zawodowych w Poznaniu',
          dateRange: '09.2014 - 06.2018',
          description: 'Specjalizacja: Zarządzanie transportem i zapasami.'
        }
      ]
    };
    
    const App = () => {
      const [cvData, setCvData] = useState(defaultData);
      const [view, setView] = useState('form'); // 'form' or 'preview'

      // --- PINCH TO ZOOM LOGIC ---
      const [zoomLevel, setZoomLevel] = useState(1);
      const [pinchDistance, setPinchDistance] = useState(null);
      const [pinchStartZoom, setPinchStartZoom] = useState(1);
      
      const handleTouchStart = (e) => {
        if (e.touches.length === 2) {
          const dist = Math.hypot(
            e.touches[0].pageX - e.touches[1].pageX,
            e.touches[0].pageY - e.touches[1].pageY
          );
          setPinchDistance(dist);
          setPinchStartZoom(zoomLevel);
        }
      };

      const handleTouchMove = (e) => {
        if (e.touches.length === 2 && pinchDistance) {
          const dist = Math.hypot(
            e.touches[0].pageX - e.touches[1].pageX,
            e.touches[0].pageY - e.touches[1].pageY
          );
          const delta = dist / pinchDistance;
          let newZoom = pinchStartZoom * delta;
          newZoom = Math.max(0.5, Math.min(3, newZoom)); // Limit zoom from 0.5x to 3x
          setZoomLevel(newZoom);
          e.preventDefault(); // Prevent default browser zoom actions
        }
      };

      const handleTouchEnd = () => {
        setPinchDistance(null);
      };

      // Efekt do generowania wykadrowanego obrazu po zmianie URL lub pozycji
      useEffect(() => {
        const updateCroppedImage = async () => {
            const croppedUrl = await getRoundedCanvasCroppedImage(cvData.profilePictureUrl, cvData.imagePosition);
            setCvData(prev => ({ ...prev, croppedProfilePictureUrl: croppedUrl || prev.profilePictureUrl }));
        };
        updateCroppedImage();
      }, [cvData.profilePictureUrl, cvData.imagePosition]);


      return React.createElement('div', { className: `min-h-screen flex flex-col md:flex-row ${view === 'form' ? 'mobile-view-form' : 'mobile-view-preview'}` },
        // Mobile View Toggles
        React.createElement('div', { className: "md:hidden bg-white p-4 border-b flex justify-around sticky top-0 z-10 shadow-sm" },
            React.createElement('button', {
                onClick: () => setView('form'),
                className: `px-4 py-2 text-sm font-medium rounded-lg transition ${view === 'form' ? 'bg-red-600 text-white shadow-md' : 'text-gray-600 hover:bg-gray-100'}`
            }, "Edytor"),
            React.createElement('button', {
                onClick: () => setView('preview'),
                className: `px-4 py-2 text-sm font-medium rounded-lg transition ${view === 'preview' ? 'bg-red-600 text-white shadow-md' : 'text-gray-600 hover:bg-gray-100'}`
            }, "Podgląd")
        ),

        // CV Form (lewa strona)
        React.createElement(CvForm, { cvData: cvData, setCvData: setCvData }),

        // CV Preview (prawa strona) - MODIFIED to include Toolbar, horizontal scrolling, and PINCH ZOOM
        React.createElement('div', { 
            id: "cv-preview-container", 
            className: "bg-gray-100 flex-grow w-full md:w-1/2 lg:w-3/5 overflow-y-auto overflow-x-auto flex flex-col touch-pan-x touch-pan-y",
            // Attach pinch handlers to the container
            onTouchStart: handleTouchStart,
            onTouchMove: handleTouchMove,
            onTouchEnd: handleTouchEnd
        },
            // Toolbar
            React.createElement('div', { className: "sticky top-0 z-20 bg-white/80 backdrop-blur-md border-b p-3 flex justify-end gap-2 shadow-sm" },
                React.createElement('button', { 
                    onClick: () => window.open('https://wa.me/?text=' + encodeURIComponent('Cześć! Przesyłam moje CV.'), '_blank'),
                    className: "flex items-center gap-2 bg-[#25D366] hover:bg-[#128C7E] text-white px-3 py-2 rounded text-xs md:text-sm font-medium transition shadow-sm" 
                }, React.createElement(MessageIcon, { className: "w-4 h-4" }), "WhatsApp"),
                
                React.createElement('button', { 
                    onClick: () => window.open('mailto:?subject=CV&body=' + encodeURIComponent('Cześć! Przesyłam moje CV.'), '_blank'),
                    className: "flex items-center gap-2 bg-blue-500 hover:bg-blue-600 text-white px-3 py-2 rounded text-xs md:text-sm font-medium transition shadow-sm" 
                }, React.createElement(MailIcon, { className: "w-4 h-4" }), "Email"),

                React.createElement('button', { 
                    onClick: () => generatePdf('cv-document'),
                    className: "flex items-center gap-2 bg-[#E31D2A] hover:bg-[#c41924] text-white px-3 py-2 rounded text-xs md:text-sm font-medium transition shadow-sm" 
                }, React.createElement(DownloadIcon, { className: "w-4 h-4" }), "Pobierz PDF")
            ),
            // Content Wrapper - Applies ZOOM
            React.createElement('div', { 
                className: "p-6 md:p-10 flex justify-center min-w-fit",
                style: { 
                    // Using 'zoom' property for mobile pinch functionality (works best on mobile webkit)
                    zoom: zoomLevel,
                    // Fallback for Firefox/browsers not supporting zoom property:
                    MozTransform: `scale(${zoomLevel})`,
                    MozTransformOrigin: "top center"
                }
            },
                 React.createElement(CvPreview, { cvData: cvData, id: "cv-document", className: "w-[210mm] h-auto min-h-fit" })
            )
        )
      );
    };

    // Render the App
    ReactDOM.createRoot(document.getElementById('root')).render(
      React.createElement(React.StrictMode, null, React.createElement(App))
    );
  </script>
</body>
</html>
